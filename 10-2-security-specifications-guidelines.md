# セキュリティ仕様書作成ガイドライン

WebService-Next-Hono-Base を基盤とするWebサービス開発において、セキュリティ仕様書を作成する際のガイドラインとテンプレートを提供します。

---

## 🎯 ガイドラインの目的

このガイドラインは：
- **具体的なセキュリティ仕様を定義するものではありません**
- **各プロジェクトでセキュリティ仕様書を作成する際の指針・テンプレートです**
- Better Auth + Hono + Next.js 構成での一般的なセキュリティ要件を整理しています

---

## 📋 セキュリティ仕様書に含めるべき要素

### 1. 認証・認可設計

#### 含めるべき項目
- [ ] **認証方式の選択**
  - Better Auth の認証プロバイダー設定
  - パスワード認証 / OAuth / SSO の採用方針
  - MFA（多要素認証）の要否

- [ ] **JWT・セッション管理**
  - JWT の有効期限・リフレッシュ戦略
  - セッション情報の保存場所（Cookie/LocalStorage/SessionStorage）
  - セッション固定攻撃・セッションハイジャック対策

- [ ] **認可・権限管理**
  - RBAC（Role-Based Access Control）の設計
  - API エンドポイント別のアクセス制御
  - フロントエンド画面別のアクセス制御

#### プロジェクト固有で決定すべき事項
```markdown
## 認証・認可設計

### 採用する認証方式
- [ ] メール・パスワード認証
- [ ] Google OAuth
- [ ] GitHub OAuth
- [ ] その他: ___________

### JWT設定
- アクセストークン有効期限: _____ 分
- リフレッシュトークン有効期限: _____ 日
- 署名アルゴリズム: HS256 / RS256

### 権限レベル
- [ ] Guest（未認証ユーザー）
- [ ] User（一般ユーザー）
- [ ] Admin（管理者）
- [ ] その他: ___________
```

### 2. データ保護

#### 含めるべき項目
- [ ] **パスワード管理**
  - ハッシュ化アルゴリズム（bcrypt/argon2等）
  - パスワード複雑性要件
  - パスワードリセット機能の実装

- [ ] **個人情報保護**
  - 収集する個人情報の定義
  - データの暗号化要件
  - データ保持期間・削除ポリシー

- [ ] **データベースセキュリティ**
  - 接続情報の管理（Infisical等）
  - SQLインジェクション対策
  - データベース暗号化の要否

#### プロジェクト固有で決定すべき事項
```markdown
## データ保護

### 収集する個人情報
- [ ] メールアドレス
- [ ] 氏名
- [ ] 電話番号
- [ ] 住所
- [ ] その他: ___________

### パスワードポリシー
- 最小文字数: _____ 文字
- 必須文字種:
  - [ ] 大文字
  - [ ] 小文字  
  - [ ] 数字
  - [ ] 記号

### データ保持期間
- ユーザーアカウント: _____ 年
- ログデータ: _____ ヶ月
- その他: ___________
```

### 3. ネットワークセキュリティ

#### 含めるべき項目
- [ ] **HTTPS/TLS設定**
  - SSL証明書の管理
  - HSTS（HTTP Strict Transport Security）設定
  - TLS バージョン要件

- [ ] **CORS設定**
  - 許可するOriginの定義
  - 認証情報付きリクエストの制御
  - プリフライトリクエストの処理

- [ ] **CSP（Content Security Policy）**
  - インラインスクリプト・スタイルの制御
  - 外部リソース読み込みの制限
  - XSS攻撃対策

#### プロジェクト固有で決定すべき事項
```markdown
## ネットワークセキュリティ

### CORS設定
- 開発環境Origin: http://localhost:3000
- 本番環境Origin: https://yourdomain.com
- その他許可Origin: ___________

### CSP設定
- script-src: 'self' ___________
- style-src: 'self' 'unsafe-inline' ___________
- img-src: 'self' data: ___________
```

### 4. 脆弱性対策

#### 含めるべき項目
- [ ] **XSS（Cross-Site Scripting）対策**
  - 入力値の検証・サニタイゼーション
  - 出力値のエスケープ処理
  - CSP による制御

- [ ] **CSRF（Cross-Site Request Forgery）対策**
  - CSRFトークンの生成・検証
  - SameSite Cookie の設定
  - Referer チェック

- [ ] **SQLインジェクション対策**
  - パラメータ化クエリの使用
  - 入力値検証
  - Drizzle ORM の適切な使用

#### プロジェクト固有で決定すべき事項
```markdown
## 脆弱性対策

### 入力値検証
- メールアドレス: RFC準拠の正規表現
- パスワード: _____ の要件
- 一般テキスト: HTMLタグ除去 / エスケープ

### レート制限
- ログイン試行: _____ 回/分
- API リクエスト: _____ 回/時間
- パスワードリセット: _____ 回/日
```

---

## 🛡️ Better Auth 固有の考慮事項

### Better Auth 設定で必須の項目

```typescript
// better-auth.config.ts の設定例
export const authConfig = {
  // プロジェクト固有で設定が必要
  secret: process.env.BETTER_AUTH_SECRET, // 32文字以上のランダム文字列
  baseURL: process.env.BETTER_AUTH_URL,   // アプリケーションのベースURL
  
  // 認証プロバイダーの選択
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    }
    // プロジェクトに応じて追加
  },
  
  // セッション設定
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7日間（プロジェクト要件に応じて調整）
    updateAge: 60 * 60 * 24,     // 1日間
  },
}
```

### プロジェクトで決定すべき Better Auth 設定

```markdown
## Better Auth 設定

### 基本設定
- SECRET: [32文字以上のランダム文字列を生成]
- BASE_URL: [アプリケーションのベースURL]

### 認証プロバイダー
- [ ] メール・パスワード
- [ ] Google OAuth
- [ ] GitHub OAuth
- [ ] その他: ___________

### セッション設定
- セッション有効期限: _____ 日
- セッション更新間隔: _____ 時間
```

---

## 🔐 環境変数管理（Infisical統合）

### セキュリティ関連の環境変数

```bash
# 認証関連
BETTER_AUTH_SECRET=     # 32文字以上のランダム文字列
BETTER_AUTH_URL=        # アプリケーションのベースURL

# OAuth設定（使用する場合）
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=

# データベース
DATABASE_URL=           # PostgreSQL接続文字列

# その他セキュリティ設定
CORS_ORIGIN=           # CORS許可Origin
CSP_SCRIPT_SRC=        # CSP script-src設定
```

### 環境変数セキュリティチェックリスト

- [ ] すべてのシークレット情報を Infisical で管理
- [ ] 開発・ステージング・本番で異なる値を設定
- [ ] 定期的なローテーション計画を策定
- [ ] アクセス権限の最小化（必要な人だけ）

---

## 📊 セキュリティテスト計画

### テストすべき項目

```markdown
## セキュリティテスト計画

### 認証・認可テスト
- [ ] 正常な認証フロー
- [ ] 不正な認証情報での失敗
- [ ] セッション有効期限切れ
- [ ] 権限不足でのアクセス拒否
- [ ] JWT改ざん検出

### 脆弱性テスト
- [ ] XSS攻撃の防御
- [ ] CSRF攻撃の防御
- [ ] SQLインジェクション防御
- [ ] レート制限の動作確認

### データ保護テスト
- [ ] パスワードハッシュ化確認
- [ ] 個人情報の適切な暗号化
- [ ] データ削除の完全性
```

---

## 🚨 インシデント対応計画

### セキュリティインシデント発生時の対応

```markdown
## インシデント対応計画

### 検知・報告
1. セキュリティイベントの検知方法: ___________
2. 報告先・連絡体制: ___________
3. 初動対応者: ___________

### 対応手順
1. 影響範囲の特定
2. 攻撃の遮断・システム保護
3. 証拠保全・ログ収集
4. 復旧作業
5. 事後分析・再発防止策

### ユーザー通知
- 通知が必要な事案: ___________
- 通知方法: ___________
- 通知タイミング: ___________
```

---

## ✅ セキュリティ仕様書作成チェックリスト

### 作成時のチェック項目

- [ ] 認証・認可設計が明確に定義されている
- [ ] データ保護要件が具体的に記載されている
- [ ] ネットワークセキュリティ設定が適切である
- [ ] 脆弱性対策が網羅されている
- [ ] Better Auth 設定が適切である
- [ ] 環境変数管理が安全である
- [ ] セキュリティテスト計画が策定されている
- [ ] インシデント対応計画が準備されている

### レビュー時のチェック項目

- [ ] 業界標準・ベストプラクティスに準拠している
- [ ] プロジェクト固有の要件が反映されている
- [ ] 実装可能性が確認されている
- [ ] 運用・保守の観点が考慮されている

---

## 📚 参考資料・標準

### セキュリティ標準・ガイドライン
- **OWASP Web Application Security Project**
  - OWASP Top 10
  - OWASP Application Security Verification Standard (ASVS)
- **NIST Cybersecurity Framework**
- **ISO/IEC 27001 情報セキュリティマネジメント**

### 技術固有の参考資料
- [Better Auth Documentation](https://better-auth.com/docs)
- [Next.js Security Best Practices](https://nextjs.org/docs/pages/building-your-application/authentication)
- [Hono Security Guidelines](https://hono.dev/guides/security)

---

## 🎯 次のステップ

1. **プロジェクト要件の整理**: 具体的なWebサービスの要件を整理
2. **セキュリティ仕様書の作成**: このガイドラインに基づいて具体的な仕様書を作成
3. **実装への反映**: 仕様書に基づいてセキュリティ機能を実装
4. **テスト・検証**: セキュリティテスト計画に基づいて検証
5. **定期的な見直し**: セキュリティ脅威の変化に応じて仕様書を更新

---

© 2025 WebService-Next-Hono-Base Development Team
