# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ä»•æ§˜æ›¸ä½œæˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**WebService-Next-Hono-Base** ã‚’åŸºç›¤ã¨ã—ã¦å®Ÿã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ç™ºã™ã‚‹éš›ã®ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ä»•æ§˜æ›¸ä½œæˆã«ãŠã‘ã‚‹è¨­è¨ˆæŒ‡é‡ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚

---

## ğŸ¯ æœ¬ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®ä½¿ã„æ–¹

### å¯¾è±¡èª­è€…
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆè€…**: ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒªãƒ³ã‚°æ™‚
- **æŠ€è¡“ä»•æ§˜æ›¸ä½œæˆè€…**: DBè¨­è¨ˆæ›¸ãƒ»ERå›³ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»•æ§˜ä½œæˆæ™‚  
- **é–‹ç™ºãƒªãƒ¼ãƒ€ãƒ¼**: ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆæ™‚

### æ´»ç”¨å ´é¢
- **ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é–¢ä¿‚ãƒ»æ­£è¦åŒ–ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆæ™‚
- **ä»•æ§˜æ›¸ä½œæˆ**: ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ»åˆ¶ç´„ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä»•æ§˜æ›¸ä½œæˆæ™‚
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ä»•æ§˜ç­–å®šæ™‚
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆ**: ã‚¯ã‚¨ãƒªæœ€é©åŒ–ãƒ»ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä»•æ§˜ç­–å®šæ™‚

---

## ğŸ¯ WebService-Next-Hono-Base ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆåŸå‰‡

### æœ¬ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆ
ã“ã®ãƒ™ãƒ¼ã‚¹ã§ã¯ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ï¼š

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | ä»•æ§˜æ›¸ã§ã®è€ƒæ…®ç‚¹ |
|---------------|------|------------------|
| **PostgreSQL** | ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆãƒ»åˆ¶ç´„ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ |
| **Drizzle ORM** | å‹å®‰å…¨ORM | ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ |
| **Better Auth** | èªè¨¼ãƒ‡ãƒ¼ã‚¿ç®¡ç† | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»æ¨©é™ã‚¹ã‚­ãƒ¼ãƒçµ±åˆ |
| **Zod** | ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | ã‚¹ã‚­ãƒ¼ãƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å‹æ•´åˆæ€§ |

### æŠ€è¡“ä»•æ§˜æ›¸ã§å®šç¾©ã™ã¹ããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦ç´ 

| è¨­è¨ˆè¦ç´  | æŠ€è¡“ä»•æ§˜æ›¸ã§ã®å®šç¾©å†…å®¹ | æœ¬ãƒ™ãƒ¼ã‚¹ã§ã®å®Ÿç¾æ–¹æ³• |
|---------|----------------------|---------------------|
| **ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ** | ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚«ãƒ©ãƒ ãƒ»åˆ¶ç´„ãƒ»é–¢ä¿‚æ€§ | Drizzleã‚¹ã‚­ãƒ¼ãƒå®šç¾© + å‹ç”Ÿæˆ |
| **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§** | åˆ¶ç´„ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | PostgreSQLåˆ¶ç´„ + Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | Drizzleãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»ã‚¯ã‚¨ãƒªæœ€é©åŒ–ãƒ»åˆ†æ | PostgreSQLæœ€é©åŒ– + ç›£è¦–çµ±åˆ |

---

## ğŸ“‹ åŸºæœ¬è¨­è¨ˆåŸå‰‡

### 1. å‹å®‰å…¨æ€§ã®å„ªå…ˆ
```mermaid
graph LR
    A[Schemaå®šç¾©] --> B[Drizzleå‹ç”Ÿæˆ]
    B --> C[ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤]
    C --> D[APIå±¤]
    D --> E[ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰]
```

### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
```mermaid
graph LR
    A[Schemaå¤‰æ›´] --> B[Migrationç”Ÿæˆ]
    B --> C[ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª]
    C --> D[ç’°å¢ƒåˆ¥é©ç”¨]
    D --> E[ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†]
```

### 3. ç’°å¢ƒåˆ†é›¢æˆ¦ç•¥

| ç’°å¢ƒå | ãƒ–ãƒ©ãƒ³ãƒ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å | ç”¨é€” |
|-------|----------|-------------|------|
| **Development** | `feature/*` | `webservice_dev` | æ©Ÿèƒ½é–‹ç™ºãƒ»PRç¢ºèª |
| **Staging** | `develop` | `webservice_staging` | çµ±åˆãƒ†ã‚¹ãƒˆãƒ»å—å…¥ãƒ†ã‚¹ãƒˆ |
| **Production** | `main` + `v*.*.*` | `webservice_production` | æœ¬ç•ªç¨¼åƒ |

```mermaid
graph TB
    A[Production DB<br/>webservice_production] --> B[Staging DB<br/>webservice_staging]
    B --> C[Development DB<br/>webservice_dev]  
    C --> D[Test DB<br/>webservice_test]
    E[Local DB<br/>å„é–‹ç™ºè€…ãƒ­ãƒ¼ã‚«ãƒ«] --> C
```

---

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```
ops/
  db/
    schema/
      users.ts          # ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
      auth.ts           # èªè¨¼é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
      core.ts           # å…±é€šãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»å‹å®šç¾©
      index.ts          # ã‚¹ã‚­ãƒ¼ãƒçµ±åˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    migrations/
      20250101000000_initial_schema.sql
      20250102000000_add_user_profiles.sql
      meta/
        _journal.json    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´
    seeds/
      dev.ts           # é–‹ç™ºç”¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
      test.ts          # ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
    drizzle.config.ts  # Drizzleè¨­å®š
packages/
  infrastructure/
    db/
      client.ts        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
      types.ts         # ç”Ÿæˆã•ã‚ŒãŸå‹å®šç¾©
      repositories/    # ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…
```

---

## ğŸ—ƒï¸ åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ

### Better Authçµ±åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»èªè¨¼ãƒ†ãƒ¼ãƒ–ãƒ«

```typescript
// ops/db/schema/auth.ts
import { pgTable, text, timestamp, boolean, json } from 'drizzle-orm/pg-core'
import { createId } from '@paralleldrive/cuid2'

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆBetter Authæ¨™æº–ï¼‰
export const users = pgTable('users', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  email: text('email').notNull().unique(),
  emailVerified: boolean('email_verified').default(false),
  name: text('name').notNull(),
  image: text('image'),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
})

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆBetter Authæ¨™æº–ï¼‰
export const sessions = pgTable('sessions', {
  id: text('id').primaryKey(),
  userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  expiresAt: timestamp('expires_at', { withTimezone: true }).notNull(),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
})

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆOAuthå¯¾å¿œï¼‰
export const accounts = pgTable('accounts', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  accountId: text('account_id').notNull(),
  providerId: text('provider_id').notNull(),
  accessToken: text('access_token'),
  refreshToken: text('refresh_token'),
  expiresAt: timestamp('expires_at', { withTimezone: true }),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
})

// æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ¡ãƒ¼ãƒ«èªè¨¼ç­‰ï¼‰
export const verificationTokens = pgTable('verification_tokens', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  token: text('token').notNull().unique(),
  identifier: text('identifier').notNull(), // emailç­‰
  expires: timestamp('expires', { withTimezone: true }).notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
})
```

### æ‹¡å¼µå¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­è¨ˆ

```typescript
// ops/db/schema/users.ts
import { pgTable, text, timestamp, integer, json } from 'drizzle-orm/pg-core'
import { users } from './auth.js'

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ‹¡å¼µãƒ†ãƒ¼ãƒ–ãƒ«
export const userProfiles = pgTable('user_profiles', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }).unique(),
  displayName: text('display_name'),
  bio: text('bio'),
  location: text('location'),
  website: text('website'),
  birthDate: timestamp('birth_date'),
  timezone: text('timezone').default('UTC'),
  locale: text('locale').default('ja'),
  preferences: json('preferences').$type<UserPreferences>(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
})

// å‹å®‰å…¨ãªJSONã‚¹ã‚­ãƒ¼ãƒå®šç¾©
export interface UserPreferences {
  theme: 'light' | 'dark' | 'system'
  notifications: {
    email: boolean
    push: boolean
    sms: boolean
  }
  privacy: {
    profilePublic: boolean
    showEmail: boolean
    showLocation: boolean
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™ç®¡ç†
export const userRoles = pgTable('user_roles', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  role: text('role').notNull(), // 'admin', 'moderator', 'user'
  grantedBy: text('granted_by').references(() => users.id),
  grantedAt: timestamp('granted_at', { withTimezone: true }).defaultNow().notNull(),
  expiresAt: timestamp('expires_at', { withTimezone: true }),
})
```

### å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

```typescript
// ops/db/schema/core.ts
import { timestamp, text } from 'drizzle-orm/pg-core'
import { createId } from '@paralleldrive/cuid2'

// å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
export const commonFields = {
  id: () => text('id').primaryKey().$defaultFn(() => createId()),
  createdAt: () => timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: () => timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: (tableName?: string) => text('created_by').references(() => users.id),
  updatedBy: (tableName?: string) => text('updated_by').references(() => users.id),
}

// ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆå¯¾å¿œ
export const softDeleteFields = {
  deletedAt: () => timestamp('deleted_at', { withTimezone: true }),
  deletedBy: () => text('deleted_by').references(() => users.id),
}

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
export const timestampTriggers = `
  CREATE OR REPLACE FUNCTION update_updated_at_column()
  RETURNS TRIGGER AS $$
  BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
  END;
  $$ language 'plpgsql';
`;

---

## ğŸš¦ ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
**ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**ã®æ°¸ç¶šåŒ–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæŒ‡é‡ï¼š

#### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æˆ¦ç•¥
```markdown
## ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é¸æŠæŒ‡é‡

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆ¥æ¨å¥¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ä¸»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | è£œåŠ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | ç”¨é€”åˆ†é›¢ |
|-----------|-------------|---------------|----------|
| **@hono/rate-limiter** | Memory | PostgreSQL | çŠ¶æ…‹ï¼šãƒ¡ãƒ¢ãƒª / å±¥æ­´ï¼šDB |
| **hono-rate-limiter** | Redis | PostgreSQL | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼šRedis / åˆ†æï¼šDB |
| **redis-rate-limiter** | Redis | PostgreSQL | å…¨ã¦ï¼šRedis / ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šDB |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³
- **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹**: Redisï¼ˆé«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹ï¼‰+ PostgreSQLï¼ˆæ°¸ç¶šåŒ–ãƒ»åˆ†æï¼‰
- **ãƒ­ã‚°ç‰¹åŒ–å‹**: åˆ¶é™çŠ¶æ…‹ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä»»ã›ã€é•åãƒ­ã‚°ã®ã¿DBç®¡ç†
- **è¨­å®šç®¡ç†å‹**: å‹•çš„ãªåˆ¶é™è¨­å®šå¤‰æ›´ã‚’DBç®¡ç†
```

#### ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆçŠ¶æ…‹ç®¡ç†
```typescript
// ops/db/schema/rate-limits.ts
import { pgTable, text, integer, timestamp, index } from 'drizzle-orm/pg-core'

// ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆçŠ¶æ…‹ãƒ†ãƒ¼ãƒ–ãƒ«
export const rateLimitStates = pgTable('rate_limit_states', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  key: text('key').notNull().unique(), // IP_endpoint ã¾ãŸã¯ userID_endpoint
  scope: text('scope').notNull(), // 'ip', 'user', 'api_key'
  identifier: text('identifier').notNull(), // IP address, user ID, API key
  endpoint: text('endpoint').notNull(), // API endpoint path
  requestCount: integer('request_count').notNull().default(0),
  windowStart: timestamp('window_start', { withTimezone: true }).notNull(),
  windowEnd: timestamp('window_end', { withTimezone: true }).notNull(),
  lastRequest: timestamp('last_request', { withTimezone: true }).defaultNow().notNull(),
  isBlocked: boolean('is_blocked').default(false),
  blockExpiresAt: timestamp('block_expires_at', { withTimezone: true }),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  keyIdx: index('rate_limit_key_idx').on(table.key),
  identifierIdx: index('rate_limit_identifier_idx').on(table.identifier),
  endpointIdx: index('rate_limit_endpoint_idx').on(table.endpoint),
  windowEndIdx: index('rate_limit_window_end_idx').on(table.windowEnd),
}))

// ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆé•åãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
export const rateLimitViolations = pgTable('rate_limit_violations', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  identifier: text('identifier').notNull(), // IP ã¾ãŸã¯ UserID
  endpoint: text('endpoint').notNull(),
  method: text('method').notNull(),
  userAgent: text('user_agent'),
  referer: text('referer'),
  requestsAttempted: integer('requests_attempted').notNull(),
  limitAllowed: integer('limit_allowed').notNull(),
  windowDuration: text('window_duration').notNull(), // '15m', '1h'
  violationType: text('violation_type').notNull(), // 'soft', 'hard', 'malicious'
  blockDuration: integer('block_duration'), // ç§’æ•°
  isAutoBlocked: boolean('is_auto_blocked').default(false),
  clientInfo: json('client_info').$type<{
    ip: string
    country?: string
    userAgent: string
    headers: Record<string, string>
  }>(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  identifierIdx: index('violation_identifier_idx').on(table.identifier),
  endpointIdx: index('violation_endpoint_idx').on(table.endpoint),
  createdAtIdx: index('violation_created_at_idx').on(table.createdAt),
  violationTypeIdx: index('violation_type_idx').on(table.violationType),
}))

// IPé®æ–­ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
export const ipBlockList = pgTable('ip_block_list', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  ipAddress: text('ip_address').notNull().unique(),
  reason: text('reason').notNull(), // 'rate_limit', 'suspicious', 'manual'
  blockType: text('block_type').notNull(), // 'temporary', 'permanent'
  expiresAt: timestamp('expires_at', { withTimezone: true }),
  blockedBy: text('blocked_by').references(() => users.id), // æ‰‹å‹•é®æ–­æ™‚ã®ç®¡ç†è€…
  autoBlocked: boolean('auto_blocked').default(true),
  violationCount: integer('violation_count').notNull().default(1),
  lastViolation: timestamp('last_violation', { withTimezone: true }).defaultNow().notNull(),
  notes: text('notes'), // ç®¡ç†è€…ãƒ¡ãƒ¢
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  ipIdx: index('ip_block_ip_idx').on(table.ipAddress),
  expiresAtIdx: index('ip_block_expires_idx').on(table.expiresAt),
  blockTypeIdx: index('ip_block_type_idx').on(table.blockType),
}))
```

#### ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆè¨­å®šç®¡ç†
```typescript
// ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆè¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‹•çš„è¨­å®šå¤‰æ›´ç”¨ï¼‰
export const rateLimitConfigs = pgTable('rate_limit_configs', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  endpoint: text('endpoint').notNull(), // '/auth/login', '/api/users'
  method: text('method'), // 'POST', 'GET', nullï¼ˆå…¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
  scope: text('scope').notNull(), // 'ip', 'user', 'api_key'
  requestLimit: integer('request_limit').notNull(),
  windowDuration: text('window_duration').notNull(), // '15m', '1h', '1d'
  blockDuration: text('block_duration'), // '15m', '1h'
  isActive: boolean('is_active').default(true),
  priority: integer('priority').default(0), // å„ªå…ˆé †ä½ï¼ˆé«˜ã„å€¤ãŒå„ªå…ˆï¼‰
  description: text('description'),
  createdBy: text('created_by').references(() => users.id),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  endpointIdx: index('rate_config_endpoint_idx').on(table.endpoint),
  scopeIdx: index('rate_config_scope_idx').on(table.scope),
  priorityIdx: index('rate_config_priority_idx').on(table.priority),
}))
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
```markdown
## ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆDBè¨­è¨ˆã®è€ƒæ…®ç‚¹

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­è¨ˆ
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ: æ¤œç´¢é »åº¦ã®é«˜ã„ã‚«ãƒ©ãƒ ï¼ˆkey, identifier, endpointï¼‰
- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­è¨ˆ: æ—¥ä»˜åˆ¥ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§å¤ã„ãƒ‡ãƒ¼ã‚¿è‡ªå‹•å‰Šé™¤
- TTLè¨­å®š: æœŸé™åˆ‡ã‚Œãƒ¬ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### ãƒ‡ãƒ¼ã‚¿ä¿æŒæˆ¦ç•¥
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ…‹: 7æ—¥é–“ä¿æŒï¼ˆrate_limit_statesï¼‰
- é•åãƒ­ã‚°: 90æ—¥é–“ä¿æŒï¼ˆrate_limit_violationsï¼‰  
- é®æ–­å±¥æ­´: 1å¹´é–“ä¿æŒï¼ˆip_block_listï¼‰

### é‹ç”¨ãƒ»ç›£è¦–ã‚¯ã‚¨ãƒªä¾‹
```sql
-- ç¾åœ¨ã®åˆ¶é™çŠ¶æ³ç¢ºèª
SELECT endpoint, COUNT(*) as active_limits
FROM rate_limit_states 
WHERE window_end > NOW() 
GROUP BY endpoint;

-- é »ç¹ãªé•åè€…ã®ç‰¹å®š
SELECT identifier, COUNT(*) as violation_count
FROM rate_limit_violations 
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY identifier 
ORDER BY violation_count DESC 
LIMIT 10;
```
```

// ä½¿ç”¨ä¾‹ï¼šè¨˜äº‹ãƒ†ãƒ¼ãƒ–ãƒ«
export const posts = pgTable('posts', {
  ...commonFields,
  title: text('title').notNull(),
  content: text('content').notNull(),
  slug: text('slug').notNull().unique(),
  status: text('status').default('draft'), // 'draft', 'published', 'archived'
  ...softDeleteFields,
})
```

---

## ğŸ”§ Drizzleè¨­å®šãƒ»æ¥ç¶šç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®š

```typescript
// packages/infrastructure/db/client.ts
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from '../../../ops/db/schema/index.js'

// ç’°å¢ƒåˆ¥æ¥ç¶šè¨­å®š
const createConnection = () => {
  const connectionString = process.env.DATABASE_URL
  if (!connectionString) {
    throw new Error('DATABASE_URL environment variable is required')
  }

  // æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š
  const client = postgres(connectionString, {
    max: process.env.NODE_ENV === 'production' ? 20 : 5,
    idle_timeout: 20,
    connect_timeout: 10,
    prepare: false, // Better Auth compatibility
  })

  return drizzle(client, { 
    schema,
    logger: process.env.NODE_ENV === 'development'
  })
}

// ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§DBæ¥ç¶šã‚’ç®¡ç†
let db: ReturnType<typeof createConnection> | null = null

export const getDb = () => {
  if (!db) {
    db = createConnection()
  }
  return db
}

// å‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export type DbClient = ReturnType<typeof getDb>
export { schema }
```

### Drizzle Kitè¨­å®š

```typescript
// ops/db/drizzle.config.ts
import type { Config } from 'drizzle-kit'
import { loadEnv } from '../dev/utils/env.js'

// ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
loadEnv()

export default {
  schema: './ops/db/schema/index.ts',
  out: './ops/db/migrations',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.DATABASE_URL!,
  },
  verbose: true,
  strict: true,
  // æœ¬ç•ªç’°å¢ƒã§ã¯å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã‚’ç„¡åŠ¹åŒ–
  tablesFilter: process.env.NODE_ENV === 'production' ? [] : undefined,
} satisfies Config
```

---

## ğŸ“Š ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### åŸºæœ¬ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

```typescript
// ops/db/schema/indexes.ts
import { index, uniqueIndex } from 'drizzle-orm/pg-core'
import { users, sessions, userProfiles, posts } from './index.js'

// ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
export const userEmailIndex = uniqueIndex('user_email_idx').on(users.email)
export const userCreatedAtIndex = index('user_created_at_idx').on(users.createdAt)

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
export const sessionUserIdIndex = index('session_user_id_idx').on(sessions.userId)
export const sessionExpiresAtIndex = index('session_expires_at_idx').on(sessions.expiresAt)

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–¢é€£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
export const profileUserIdIndex = uniqueIndex('profile_user_id_idx').on(userProfiles.userId)

// è¨˜äº‹é–¢é€£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆä¾‹ï¼‰
export const postSlugIndex = uniqueIndex('post_slug_idx').on(posts.slug)
export const postStatusIndex = index('post_status_idx').on(posts.status)
export const postCreatedAtIndex = index('post_created_at_idx').on(posts.createdAt)

// è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¾‹
export const postStatusCreatedIndex = index('post_status_created_idx')
  .on(posts.status, posts.createdAt)
```

### ã‚¯ã‚¨ãƒªæœ€é©åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// packages/infrastructure/db/repositories/user.repository.ts
import { eq, and, or, desc, count, sql } from 'drizzle-orm'
import { getDb } from '../client.js'
import { users, userProfiles, sessions } from '../../../../ops/db/schema/index.js'

export class UserRepository {
  private db = getDb()

  // åŠ¹ç‡çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ï¼ˆJOINä½¿ç”¨ï¼‰
  async getUserWithProfile(userId: string) {
    return await this.db
      .select({
        id: users.id,
        email: users.email,
        name: users.name,
        image: users.image,
        profile: {
          displayName: userProfiles.displayName,
          bio: userProfiles.bio,
          location: userProfiles.location,
          preferences: userProfiles.preferences,
        }
      })
      .from(users)
      .leftJoin(userProfiles, eq(users.id, userProfiles.userId))
      .where(eq(users.id, userId))
      .limit(1)
  }

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
  async getUsersWithPagination(page = 1, limit = 20) {
    const offset = (page - 1) * limit

    const [usersData, totalCount] = await Promise.all([
      this.db
        .select()
        .from(users)
        .orderBy(desc(users.createdAt))
        .limit(limit)
        .offset(offset),
      
      this.db
        .select({ count: count() })
        .from(users)
    ])

    return {
      users: usersData,
      pagination: {
        page,
        limit,
        total: totalCount[0].count,
        pages: Math.ceil(totalCount[0].count / limit),
        hasNext: page * limit < totalCount[0].count,
        hasPrev: page > 1,
      }
    }
  }

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã®å–å¾—
  async getActiveSessionCount(userId: string) {
    const result = await this.db
      .select({ count: count() })
      .from(sessions)
      .where(
        and(
          eq(sessions.userId, userId),
          sql`${sessions.expiresAt} > NOW()`
        )
      )
    
    return result[0].count
  }
}
```

---

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```bash
# ç’°å¢ƒåˆ¥ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

# 1. ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å¾Œã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
pnpm db:generate

# 2. ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
# ops/db/migrations/ å†…ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª

# 3. Developmentç’°å¢ƒã«é©ç”¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼‰
infisical run --env=development -- pnpm db:migrate

# 4. Stagingç’°å¢ƒã«é©ç”¨ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
infisical run --env=staging -- pnpm db:migrate

# 5. Productionç’°å¢ƒã¸ã®é©ç”¨ï¼ˆæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ãƒ»æ…é‡ã«ï¼‰
infisical run --env=production -- pnpm db:migrate:prod
```

### package.json ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨­å®š

```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate:pg --config=ops/db/drizzle.config.ts",
    "db:migrate": "drizzle-kit push:pg --config=ops/db/drizzle.config.ts",
    "db:migrate:prod": "drizzle-kit migrate:pg --config=ops/db/drizzle.config.ts",
    "db:studio": "drizzle-kit studio --config=ops/db/drizzle.config.ts",
    "db:drop": "drizzle-kit drop --config=ops/db/drizzle.config.ts",
    "db:seed": "tsx ops/db/seeds/dev.ts",
    "db:seed:test": "tsx ops/db/seeds/test.ts"
  }
}
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯

```typescript
// ops/db/migrations/safety-check.ts
export const migrationSafetyChecklist = {
  // å±é™ºãªæ“ä½œã®æ¤œå‡º
  dangerousOperations: [
    'DROP TABLE',
    'DROP COLUMN', 
    'ALTER COLUMN ... DROP NOT NULL',
    'ALTER COLUMN ... TYPE', // ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚’ä¼´ã†å‹å¤‰æ›´
  ],
  
  // æœ¬ç•ªé©ç”¨å‰ã®ç¢ºèªäº‹é …
  preProductionChecklist: [
    'â–¡ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Œäº†',
    'â–¡ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—æ¸ˆã¿',
    'â–¡ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®ç¢ºèªæ¸ˆã¿',
    'â–¡ å½±éŸ¿ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ç¢ºèª',
    'â–¡ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†æ§‹ç¯‰æ™‚é–“ã®è¦‹ç©ã‚‚ã‚Š',
    'â–¡ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢æ™‚é–“ã®èª¿æ•´',
  ]
}
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ»ã‚·ãƒ¼ãƒ‰ç®¡ç†

### é–‹ç™ºç”¨ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿

```typescript
// ops/db/seeds/dev.ts
import { getDb } from '../../packages/infrastructure/db/client.js'
import { users, userProfiles } from '../schema/index.js'
import { createId } from '@paralleldrive/cuid2'

const db = getDb()

export async function seedDevData() {
  console.log('ğŸŒ± Seeding development data...')

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
  const sampleUsers = [
    {
      id: createId(),
      email: 'admin@example.com',
      name: 'ç®¡ç†è€…',
      emailVerified: true,
    },
    {
      id: createId(),
      email: 'user1@example.com', 
      name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼1',
      emailVerified: true,
    },
    {
      id: createId(),
      email: 'user2@example.com',
      name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼2', 
      emailVerified: false,
    }
  ]

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ¿å…¥
  const insertedUsers = await db.insert(users).values(sampleUsers).returning()
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆ
  const profiles = insertedUsers.map(user => ({
    id: createId(),
    userId: user.id,
    displayName: `${user.name}ï¼ˆè¡¨ç¤ºåï¼‰`,
    bio: `${user.name}ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§ã™ã€‚`,
    timezone: 'Asia/Tokyo',
    locale: 'ja',
    preferences: {
      theme: 'light' as const,
      notifications: {
        email: true,
        push: true, 
        sms: false,
      },
      privacy: {
        profilePublic: true,
        showEmail: false,
        showLocation: true,
      }
    }
  }))

  await db.insert(userProfiles).values(profiles)

  console.log('âœ… Development data seeded successfully!')
}

// ç›´æ¥å®Ÿè¡Œã®å ´åˆ
if (import.meta.url === `file://${process.argv[1]}`) {
  seedDevData().catch(console.error)
}
```

### ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼

```typescript
// ops/db/seeds/factories.ts
import { faker } from '@faker-js/faker/locale/ja'
import { createId } from '@paralleldrive/cuid2'
import type { UserPreferences } from '../schema/users.js'

export const UserFactory = {
  build: (overrides: Partial<typeof users.$inferInsert> = {}) => ({
    id: createId(),
    email: faker.internet.email(),
    name: faker.person.fullName(),
    emailVerified: faker.datatype.boolean(0.8), // 80%ã®ç¢ºç‡ã§true
    createdAt: new Date(),
    updatedAt: new Date(),
    ...overrides,
  }),

  buildMany: (count: number, overrides: Partial<typeof users.$inferInsert> = {}) => {
    return Array.from({ length: count }, () => UserFactory.build(overrides))
  }
}

export const UserProfileFactory = {
  build: (userId: string, overrides: Partial<typeof userProfiles.$inferInsert> = {}) => ({
    id: createId(),
    userId,
    displayName: faker.person.fullName(),
    bio: faker.lorem.paragraph(),
    location: faker.location.city(),
    website: faker.internet.url(),
    timezone: faker.helpers.arrayElement(['Asia/Tokyo', 'UTC', 'America/New_York']),
    locale: faker.helpers.arrayElement(['ja', 'en', 'ko']),
    preferences: {
      theme: faker.helpers.arrayElement(['light', 'dark', 'system']),
      notifications: {
        email: faker.datatype.boolean(),
        push: faker.datatype.boolean(),
        sms: faker.datatype.boolean(),
      },
      privacy: {
        profilePublic: faker.datatype.boolean(0.7),
        showEmail: faker.datatype.boolean(0.3),
        showLocation: faker.datatype.boolean(0.6),
      }
    } satisfies UserPreferences,
    createdAt: new Date(),
    updatedAt: new Date(),
    ...overrides,
  })
}
```

---

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

```typescript
// packages/infrastructure/db/security.ts

// 1. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆDrizzleã§è‡ªå‹•çš„ã«å¯¾ç­–æ¸ˆã¿ï¼‰
export const safeQuery = {
  // âŒ å±é™ºï¼šç”Ÿã®SQL
  unsafe: (userInput: string) => sql`SELECT * FROM users WHERE name = ${userInput}`,
  
  // âœ… å®‰å…¨ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
  safe: (userInput: string) => db.select().from(users).where(eq(users.name, userInput))
}

// 2. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
export const secureUserQuery = (requestUserId: string, targetUserId: string) => {
  // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‹ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
  const isOwner = requestUserId === targetUserId
  const isAdmin = checkAdminRole(requestUserId) // å®Ÿè£…ã¯çœç•¥
  
  if (!isOwner && !isAdmin) {
    throw new Error('Unauthorized access to user data')
  }
  
  return db.select().from(users).where(eq(users.id, targetUserId))
}

// 3. æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–
export const publicUserFields = {
  id: users.id,
  name: users.name,
  image: users.image,
  // email, createdAt ã¯é™¤å¤–
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

```typescript
// packages/infrastructure/db/monitoring.ts
import { performance } from 'perf_hooks'

export const withQueryLogging = async <T>(
  queryName: string, 
  queryFn: () => Promise<T>
): Promise<T> => {
  const start = performance.now()
  
  try {
    const result = await queryFn()
    const duration = performance.now() - start
    
    // é…ã„ã‚¯ã‚¨ãƒªã®è­¦å‘Š
    if (duration > 1000) { // 1ç§’ä»¥ä¸Š
      console.warn(`ğŸŒ Slow query detected: ${queryName} took ${duration.toFixed(2)}ms`)
    }
    
    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
    if (process.env.NODE_ENV === 'production') {
      // sendMetrics('db.query.duration', duration, { query: queryName })
    }
    
    return result
  } catch (error) {
    console.error(`âŒ Query failed: ${queryName}`, error)
    throw error
  }
}

// ä½¿ç”¨ä¾‹
export const getUserById = (id: string) =>
  withQueryLogging('getUserById', () =>
    db.select().from(users).where(eq(users.id, id)).limit(1)
  )
```

---

## âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ
- [ ] ãƒ†ãƒ¼ãƒ–ãƒ«åãƒ»ã‚«ãƒ©ãƒ åãŒsnake_caseã§çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹
- [ ] ä¸»ã‚­ãƒ¼ãŒtextå‹ã®CUID2ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆonDelete: 'cascade'ç­‰ï¼‰
- [ ] NOT NULLåˆ¶ç´„ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãŒå¿…è¦ãªé …ç›®ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆcreated_at, updated_atï¼‰ãŒå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] Better Authç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
- [ ] æ¤œç´¢ã§ä½¿ç”¨ã•ã‚Œã‚‹é …ç›®ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é …ç›®é †åºãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ä¸è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒé™¤å»ã•ã‚Œã¦ã„ã‚‹

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒé©åˆ‡ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- [ ] å±é™ºãªæ“ä½œï¼ˆDROPç­‰ï¼‰ãŒæœ¬ç•ªé©ç”¨å‰ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆæ¸ˆã¿

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆDrizzleã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ä½¿ç”¨ï¼‰
- [ ] æ©Ÿå¯†æƒ…å ±ã®é©åˆ‡ãªé™¤å¤–ï¼ˆå…¬é–‹APIç”¨ï¼‰
- [ ] ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å®Ÿè£…
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ã®æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ç¢ºèª

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- [ ] é…ã„ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- [ ] N+1å•é¡Œã®å›é¿ï¼ˆJOINä½¿ç”¨ï¼‰
- [ ] ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
- [ ] ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ã®ç›£è¦–è¨­å®š

---

## ğŸ› ï¸ é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«

### Drizzle Studio ã®æ´»ç”¨

```bash
# Drizzle Studio ã®èµ·å‹•ï¼ˆGUIã§DBç¢ºèªãƒ»ç·¨é›†ï¼‰
pnpm db:studio

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:4983 ã«ã‚¢ã‚¯ã‚»ã‚¹
# ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ãƒ»ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªãƒ»ç·¨é›†ãŒå¯èƒ½
```

### ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¯ã‚¨ãƒª

```typescript
// packages/infrastructure/db/debug.ts
import { getDb } from './client.js'

export const debugQueries = {
  // ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã®ç¢ºèª
  async getTableInfo(tableName: string) {
    const db = getDb()
    return await db.execute(sql`
      SELECT column_name, data_type, is_nullable, column_default
      FROM information_schema.columns 
      WHERE table_name = ${tableName}
      ORDER BY ordinal_position
    `)
  },

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æƒ…å ±ã®ç¢ºèª
  async getIndexInfo(tableName: string) {
    const db = getDb()
    return await db.execute(sql`
      SELECT indexname, indexdef
      FROM pg_indexes 
      WHERE tablename = ${tableName}
    `)
  },

  // ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
  async explainQuery(query: string) {
    const db = getDb()
    return await db.execute(sql`EXPLAIN ANALYZE ${sql.raw(query)}`)
  }
}
```

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **åŸºæœ¬ã‚¹ã‚­ãƒ¼ãƒã®å®Ÿè£…**: Better Authå¯¾å¿œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»èªè¨¼ãƒ†ãƒ¼ãƒ–ãƒ«
2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š**: Drizzle Kitè¨­å®šã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œç’°å¢ƒ
3. **ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…**: å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®æ§‹ç¯‰
4. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ•´å‚™**: é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä½œæˆ
5. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã®å®Ÿè£…

---

## ğŸ“š å‚è€ƒè³‡æ–™

### Drizzle ORM
- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [PostgreSQL with Drizzle](https://orm.drizzle.team/docs/get-started-postgresql)
- [Drizzle Kit CLI](https://orm.drizzle.team/kit-docs/overview)

### PostgreSQL
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [PostgreSQL Performance Tips](https://wiki.postgresql.org/wiki/Performance_Optimization)

### Better Authçµ±åˆ
- [Better Auth with Drizzle](https://www.better-auth.com/docs/adapters/drizzle-adapter)

---

Â© 2025 WebService-Next-Hono-Base Development Team
